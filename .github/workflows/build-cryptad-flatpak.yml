name: Build cryptad flatpak (x86_64/aarch64)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g. 1.2.3). If set, checks out release/<version>"
        required: false
        default: ""
      branch:
        description: "Branch or tag to build when version is empty"
        required: false
        default: "main"

jobs:
  build:
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - flatpak_arch: x86_64
            runner: ubuntu-latest
          - flatpak_arch: aarch64
            runner: ubuntu-24.04-arm

    steps:
      - name: Checkout release-ops repo
        uses: actions/checkout@v4

      - name: Decide upstream ref
        id: ref
        run: |
          set -euo pipefail
          echo "::group::Select upstream ref"
          if [ -n "${{ inputs.version }}" ]; then
            SELECTED="release/${{ inputs.version }}"
          else
            SELECTED="${{ inputs.branch }}"
          fi
          echo "::debug::Selected upstream ref: $SELECTED"
          echo "ref=$SELECTED" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"

      - name: Checkout upstream cryptad (${{ steps.ref.outputs.ref }})
        uses: actions/checkout@v4
        with:
          repository: crypta-network/cryptad
          ref: ${{ steps.ref.outputs.ref }}
          path: upstream

      - name: Set up JDK 21 (temurin)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Determine version via gradle printVersion or fallback
        id: ver
        working-directory: upstream
        run: |
          set -euo pipefail
          D(){ echo "::debug::$*"; }
          echo "::group::Resolve version"
          VERSION_INPUT='${{ inputs.version }}'
          if [ -n "$VERSION_INPUT" ]; then
            VERSION="$VERSION_INPUT"
          else
            VERSION=""
            echo "::group::List Gradle tasks"
            D "Listing Gradle tasks (for printVersion)..."
            if ! ./gradlew -q tasks --all > ../_gradle_tasks.txt 2>&1; then
              D "gradlew tasks failed (continuing). Exit recorded."
            fi
            D "Tasks grep (printVersion):"
            grep -i "printVersion" ../_gradle_tasks.txt | sed 's/^/::debug::[tasks] /' || true
            echo "::endgroup::"
            if grep -Eq '(^|\s)printVersion(\s|$)' ../_gradle_tasks.txt; then
              echo "::group::Run printVersion task"
              D "printVersion task detected; invoking..."
              if ./gradlew -q printVersion > ../_printVersion.txt 2>&1; then
                tail -n +1 ../_printVersion.txt | sed 's/^/::debug::[printVersion] /'
                VERSION=$(tail -n1 ../_printVersion.txt | tr -d '\r\n\t' | xargs || true)
              else
                D "printVersion task run failed (continuing)."
              fi
              echo "::endgroup::"
            else
              D "No printVersion task found."
            fi
            if [ -z "$VERSION" ]; then
              echo "::group::Gradle properties (version)"
              D "Querying Gradle properties for project version..."
              if ./gradlew -q properties > ../_gradle_properties.txt 2>&1; then
                tail -n +1 ../_gradle_properties.txt | sed 's/^/::debug::[properties] /' | head -n 40 || true
                PVER=$(awk -F': ' '/^version:/{print $2; exit}' ../_gradle_properties.txt)
                PVER=$(echo "$PVER" | tr -d '\r\n\t' | xargs)
              else
                D "gradlew properties failed (continuing)."
                PVER=""
              fi
              if [ -n "$PVER" ] && [ "$PVER" != "unspecified" ]; then
                VERSION="$PVER"
              fi
              echo "::endgroup::"
            fi
            if [ -z "$VERSION" ]; then
              echo "::group::git describe fallback"
              VERSION=$(git describe --tags --always --abbrev=0 2>/dev/null | sed 's/^v//') || true
              D "git describe version candidate: ${VERSION:-<empty>}"
              echo "::endgroup::"
            fi
          fi
          if [ -z "$VERSION" ]; then
            echo "::error::Unable to determine version"
            exit 1
          fi
          echo "::debug::Resolved version: $VERSION"
          echo "version=$VERSION" | tee -a "$GITHUB_OUTPUT"
          echo "::endgroup::"

      - name: Build upstream project (dist)
        id: build
        working-directory: upstream
        run: |
          set -euo pipefail
          D(){ echo "::debug::$*"; }
          echo "::group::Java/Gradle versions"
          D "Java version:" && (java -version 2>&1 | sed 's/^/::debug::[java] /') || true
          D "Gradle version:" && (./gradlew -v 2>&1 | sed 's/^/::debug::[gradle] /') || true
          echo "::endgroup::"
          echo "::group::Gradle build"
          ./gradlew -S -x test build || ./gradlew -S build
          echo "::endgroup::"
          VERSION="${{ steps.ver.outputs.version }}"
          TARBALL="build/distributions/cryptad-jlink-v${VERSION}.tar.gz"
          echo "::group::Locate distribution tarball"
          D "Looking for $TARBALL"
          (ls -la build/distributions | sed 's/^/::debug::[dist] /') || true
          if [ ! -f "$TARBALL" ]; then
            TARBALL=$(find build -type f -name 'cryptad-*.tar.gz' | head -n1 || true)
            D "Fallback tarball: ${TARBALL:-<none>}"
          fi
          if [ -z "$TARBALL" ] || [ ! -f "$TARBALL" ]; then
            echo "::error::No distribution tarball found under build/."
            find build -maxdepth 3 -type f -print || true
            exit 1
          fi
          TARBALL_ABS="$(pwd)/$TARBALL"
          D "Using tarball: $TARBALL"
          D "Using tarball (abs): $TARBALL_ABS"
          (du -h "$TARBALL_ABS" | sed 's/^/::debug::[du] /') || true
          (sha256sum "$TARBALL_ABS" | sed 's/^/::debug::[sha256] /') || true
          echo "$TARBALL_ABS" > "$GITHUB_WORKSPACE/.tarball-path"
          echo "::endgroup::"

      - name: Prepare Flatpak payload (repack tarball)
        run: |
          set -euo pipefail
          D(){ echo "::debug::$*"; }
          echo "::group::Extract and stage payload"
          mkdir -p flatpak/local
          TARBALL=$(cat .tarball-path)
          D "Workspace: $(pwd)"
          D "Tarball path from file: $TARBALL"
          if [ ! -f "$TARBALL" ]; then
            echo "::warning::Tarball not found at recorded path: $TARBALL"
            if [ -f "upstream/$TARBALL" ]; then
              TARBALL="upstream/$TARBALL"
              D "Adjusted tarball path to: $TARBALL"
            fi
          fi
          VERSION='${{ steps.ver.outputs.version }}'
          WORK=workpkg
          rm -rf "$WORK"
          mkdir -p "$WORK"
          tar -xzf "$TARBALL" -C "$WORK"
          D "Prepared payload for arch=${{ matrix.flatpak_arch }} version=${VERSION}"
          find "$WORK" -maxdepth 2 -type f -print | sed 's/^/::debug::[payload] /'
          echo "::endgroup::"
          echo "::group::Create payload tar for Flatpak"
          tar -C "$WORK" -czf "flatpak/local/cryptad-jlink-v${VERSION}.tar.gz" ./
          (ls -la flatpak/local | sed 's/^/::debug::[flatpak-local] /')
          echo "::endgroup::"

      - name: Generate Flatpak manifest from template
        run: |
          set -euo pipefail
          echo "::group::Generate flatpak manifest from template"
          VERSION='${{ steps.ver.outputs.version }}'
          mkdir -p flatpak
          sed "s/__VERSION__/${VERSION}/g" flatpak/cryptad.yaml.template > flatpak/cryptad.yaml
          sed -n '1,200p' flatpak/cryptad.yaml | sed 's/^/::debug::[manifest] /'
          echo "::endgroup::"

      - name: Render desktop file from shared template (Flatpak)
        run: |
          set -euo pipefail
          echo "::group::Render shared desktop file for Flatpak"
          mkdir -p flatpak
          exec_name=cryptad
          icon_name='network.crypta.cryptad'
          sed -e "s/__EXEC_NAME__/${exec_name}/g" \
              -e "s~__ICON_NAME__~${icon_name}~g" \
              desktop/cryptad.desktop.template > flatpak/cryptad.desktop
          sed -n '1,120p' flatpak/cryptad.desktop | sed 's/^/::debug::[desktop] /'
          echo "::endgroup::"

      - name: Install Flatpak tooling and runtimes
        run: |
          set -euo pipefail
          echo "::group::Install flatpak + flatpak-builder"
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          echo "::endgroup::"
          echo "::group::Configure flathub remote"
          # Add flathub to the user installation (match --user usage later)
          flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak --user remotes -d | sed 's/^/::debug::[remotes] /'
          echo "::endgroup::"
          echo "::group::Install freedesktop runtime+sdk 24.08"
          flatpak --user --noninteractive install -y flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08
          echo "::endgroup::"

      - name: Build Flatpak (manifest)
        env:
          FLATPAK_DEFAULT_ARCH: ${{ matrix.flatpak_arch }}
        run: |
          set -euo pipefail
          echo "::group::flatpak-builder ${{ matrix.flatpak_arch }}"
          rm -rf builddir repo
          flatpak-builder --force-clean --user --arch=${{ matrix.flatpak_arch }} \
            --install-deps-from=flathub \
            builddir flatpak/cryptad.yaml
          echo "::endgroup::"

      - name: Export and bundle Flatpak
        run: |
          set -euo pipefail
          VERSION='${{ steps.ver.outputs.version }}'
          APPID='network.crypta.cryptad'
          BRANCH="v${VERSION}"
          echo "::group::Export repo"
          # Export to the same branch we'll bundle (defaults to 'master' if omitted)
          flatpak build-export --arch=${{ matrix.flatpak_arch }} repo builddir "$BRANCH"
          echo "::endgroup::"
          echo "::group::Create bundle"
          BUNDLE="cryptad-flatpak-v${VERSION}-${{ matrix.flatpak_arch }}.flatpak"
          flatpak build-bundle repo "$BUNDLE" "$APPID" "$BRANCH" --arch=${{ matrix.flatpak_arch }}
          ls -la "$BUNDLE"
          echo "::endgroup::"

      - name: Upload x86_64 Flatpak bundle
        if: matrix.flatpak_arch == 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: cryptad-flatpak-${{ steps.ver.outputs.version }}-x86_64
          path: cryptad-flatpak-v${{ steps.ver.outputs.version }}-x86_64.flatpak
          if-no-files-found: error

      - name: Upload aarch64 Flatpak bundle
        if: matrix.flatpak_arch == 'aarch64'
        uses: actions/upload-artifact@v4
        with:
          name: cryptad-flatpak-${{ steps.ver.outputs.version }}-aarch64
          path: cryptad-flatpak-v${{ steps.ver.outputs.version }}-aarch64.flatpak
          if-no-files-found: error
